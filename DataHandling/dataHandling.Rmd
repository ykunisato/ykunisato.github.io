---
title: "Rで実験データのハンドリング！"
author: "専修大学人間科学部心理学科　国里愛彦"
date: "`r format(Sys.time(), '%Y/%m/%d')`"
output:
  html_document:
    md_extensions: -ascii_identifiers
    number_sections: yes
    theme: default
    toc: yes
    toc_float: yes
---

# 解析よりも解析するデータセット作成が重要！

卒論や修論の解析をする場合に，多くの人は，用いる統計解析が間違ってないか心配します。しかし，研究仮説がしっかりしぼれていれば，統計解析自体は，それほど難しくはないです。むしろ，統計解析をするためのデータセットをちゃんと準備することが難しいです。多くの人は，データセットの準備にExcelを使用します。PsychoPyを用いた認知課題は，結果の出力にcsv形式を使うことが多いかと思いますが，csvファイルは，Excelで開くことができます。そのため，多くの人が，Excelを使って，csvファイルを開いて，必要箇所をコピー＆ペーストして，データセットを作ることになります。この作業には，大きな問題があります。例えば，sub01からsub04まで，個別のcsvファイルがある時に，それぞれのcsvファイルを開いてコピー＆ペーストをして，別の解析用データセット（Excelファイル）を作るとします。この作業で，コピー＆ペーストは，みなさんのマウス操作に委ねられます。もしかすると，sub02のデータをコピーしたつもりが，上手くいっておらず，sub01のデータを貼り付けてしまうかもしれません。コピペには，こういう危険性があります。さらに，もし間違っていても，その間違いに気づけないことも多いです。

解析用データセットの作成には以下の条件が必要です。そして，それを満たしてくれるのがRによるデータハンドリングです。

1. オリジナルの生データを直接操作しない
1. オリジナルの生データから必要な情報を人力ではない形で抽出する
1. オリジナルの生データを１つのファイルにまとめて，解析可能なフォーマットに変更する
1. 上記の操作について作業ログが残り，何度でもやり直せる

# RのRstudioのインストール

Rを[R Projectのサイト](https://www.r-project.org/)からダウンロードしてインストールしてください。Windowsユーザーは，"Windows R インストール"，Macユーザーは，"Mac R インストール"などでググって，インストール方法を調べて下さい。次に，Rstudioを[Rstudioのサイト](https://www.rstudio.com/)からダウンロードしてインストールしてください。Windowsユーザーは，"Windows Rstudio インストール"，Macユーザーは，"Mac Rstudio インストール"などでググって，インストール方法を調べて下さい。

# 解析用フォルダの準備

Analysisという名前の解析用フォルダを自分のパソコンの好きな場所に作成し，その中に，Dataという名前のデータを入れるフォルダを作成します。Dataフォルダ内には，csvファイルのデータだけをいれます。今回は，逆転学習課題について，４名分の仮想データを用意してみました(sub01.csvからsub04.csvまで４つのcsvファイル)。

- [sub01.csv](Data/sub01.csv)
- [sub02.csv](Data/sub02.csv)
- [sub03.csv](Data/sub03.csv)
- [sub04.csv](Data/sub04.csv)


データをいれるDataフォルダを作成して，そこに生データのcsvファイルのみを配置します。なお，フォルダとファイルと変数名に日本語を使用するのは推奨しません。フォルダとファイルと変数名には，英語（日本語のローマ字化でけっこう）を使用してください。それでは，上のsub01.csvからsub04.csvまで４つのcsvファイルをダウンロードして，Analysisフォルダ内のDataフォルダ内に保存しましょう。

# Rstudioの作業ディレクトリーの設定
　
なお，パソコンで解析などの作業をする場合に，パソコンに，パソコン上のどこでデータを得て作業をするのか，作業している場所を知らせる場所があります。そのような作業場所を作業ディレクトリーと言います。Rstudio上で，作業ディレクトリーをAnalysisフォルダに設定します。具体的な操作は，　RStudioのメニューバーから、「Session」->「Set Working Directory」->「Choose Directory」で，Analysisフォルダを選択してください。


# カレントディレクトリーの移動

基本的には，Analysisフォルダで解析の前処理や解析は行いますが，一時的にフォルダ移動する必要があります。その時に便利なのが，getwd()とsetwd()です。wdは，作業ディレクトリ(working directory)を意味し，getwdで現在の作業ディレクトリの情報を取得し，setwdで作業ディレクトリを設定します。

以下をRstudioのConsoleにタイプしてみましょう！

```
getwd()
```

おそらく，さきほど設定したAnalysisフォルダまでのパスが出力されたかと思います（そうじゃない人は，"Rstudioの作業ディレクトリーの設定"に戻って下さい）。


次に，Analysisフォルダの１つ下の階層にあるDataフォルダに移動してみましょう。以下をRstudioのConsoleにタイプしてみましょう！

```
workDir <- getwd()
setwd(paste(workDir, "Data", sep = "/"))
```

上記のコードでは，まず１行目で，getwd()で取得した作業ディレクトリのパスをworkDirに入れます。次に，setwdを使って，workDir（作業ディレクトリのパス）とDataをpasteで結合し（sep="/"で/で区切るように設定），Analysis下のDataフォルダに作業ディレクトリを変更しています。上記を打ち込んだら，getwd()をタイプして，ちゃんとDataフォルダが作業ディレクトリになっているか確認をしよう！

なお，DataフォルダからAnalysisフォルダに戻るには，以下のsetwd("..")が便利です。

```
setwd("..")
```

上記のsetwd("..")をRstudioのConsoleに打ちこんでから，getwd()でAnalysisフォルダに戻ってきているか確認をしてみましょう。

# Dataフォルダ内のファイル名を取得

もう一度，Dataフォルダに移動します。その上で，list.filse()を使って，フォルダ内のファイル名をリスト化します（そしてfileNamesに入れる）。

```{r}
workDir <- getwd()
setwd(paste(workDir, "Data", sep = "/"))
fileNames <- list.files()
```

fileNamseの中身を確認します。フォルダに入っているファイル名がfileNamesに格納されているかと思います。

```{r}
print(fileNames)
```

# Dataフォルダ内のファイル数を確認

fileNamesに格納されているファイル名の数から参加者数を確認します。lengthでデータの長さ（ここでは，fileNamesに含まれるデータの個数）がわかります。

```{r}
numberSubject <- length(fileNames)
print(numberSubject)
```

# sub01のデータを読み込んでみる

では，sub01.csvを読み込んでみましょう！read.csv()でcsvファイルが読み込めます。そして，読み込むファイル名は，fileNamesに格納されているのものの１つ目（つまり，sub01）です。

```{r}
sub01 <- read.csv(paste(workDir, "Data",fileNames[1], sep = "/"))
head(sub01)
tail(sub01)
```


# sub01のデータで必要な部分を抽出

上記のsub01のデータで解析で必要なのは，rt（反応時間）, key_press（押したキー），correct（正誤）になる。また，trial_typeでcategorizeのデータだけが欲しい（textは教示なので，いらない）。まず，subset関数で，，trial_typeでcategorizeのデータだけにしぼる。その上で，rt（反応時間）, key_press（押したキー），correct（正誤）について，結果を整理する。

```{r}
sub01 <- read.csv(paste(workDir, "Data",fileNames[1], sep = "/"))

# sub01の結果を整理した変数として，sub01v2を使用する。
# trial_typeがcategorizeのデータに絞る
sub01v2 <- subset(sub01,trial_type=="categorize")
  
# trial_type, time_elapsed, internal_node_id, stimulusは不要なので削除（c()内で，列番号に-をつけると削除できる）
sub01v2 <- sub01v2[,c(-3,-5,-6,-8)]

# correctはtrue,falseなので，trueは1,falseは0にする
sub01v2$correct <- as.numeric(as.logical(sub01v2$correct))

# key_pressは，90だと紫，77だと緑なので，90は1，77は0にする。
sub01v2$key_press[sub01v2$key_press==90] <- 1
sub01v2$key_press[sub01v2$key_press==77] <- 0

# あとでやりやすいように変数名も変更する。
colnames(sub01v2) <- c("rt","currentChoice","no","reward")
head(sub01v2)
tail(sub01v2)
```

必要な部分だけきれいに抽出できました。

# ４名のデータの読み込みと保存
## データの読み込み

さて，今度は４名分のデータ（フォルダ内のすべてのデータ）を読み込んでみましょう。フォルダ内のデータ数分（今回は４）だけ，上記の操作を繰り返します。繰り返す場合は，for文を使います。for文は以下のように書きます。1から"繰り返す回数"までを順番にiに代入しつつ，"繰り返したい操作"を繰り返します。

```
for(i in 1:繰り返す回数){
    繰り返したい操作
}
```

csvファイルを繰り返し読み込むだけでは，それぞれをバラバラに読み込むだけなので，rbind()を使って，今あるデータに続けて，次のデータを追加します。ちなみに，rbind()を使うのは，２つめのデータからになります（1つめのデータを読み込んだ時は，その前にデータはないので，rbindで結合できない）。

```{r}
# 1からnumberSubject分（4回），操作を繰り返す
for(i in 1:numberSubject){
  # フォルダ内の読み込んだcsvファイルのデータをtempDataに保存（tempは一時的を意味するtemporaryの省略です）。
  tempData <- read.csv(paste(workDir, "Data",fileNames[i], sep = "/"))
  # 以下は１つまでの処理を変数名をtempDataに変えただけで，そのまま実行
  # trial_typeがcategorizeのデータに絞る
  tempData <- subset(tempData,trial_type=="categorize")
  # trial_type, time_elapsed, internal_node_id, stimulusは不要なので削除（c()内で，列番号に-をつけると削除できる）
  tempData <- tempData[,c(-3,-5,-6,-8)]
  # correctはtrue,falseなので，trueは1,falseは0にする
  tempData$correct <- as.numeric(as.logical(tempData$correct))
  # key_pressは，90だと紫，77だと緑なので，90は1，77は0にする。
  tempData$key_press[tempData$key_press==90] <- 1
  tempData$key_press[tempData$key_press==77] <- 0
  # 参加者idの追加（繰り返しの番号iをデータの長さ分用意）
  tempData$id <- rep(i,length(tempData$rt))
  # あとでやりやすいように変数名も変更する。
  colnames(tempData) <- c("rt","currentChoice","no","reward","id")
  # 2回目以降は，rbindでその前のデータ（rawData）に追加していく。
  if (i==1){
    rawData = tempData
  }else{
    rawData = rbind(rawData, tempData)
  }
}

# rawDataの最初と最後を確認
head(rawData)
tail(rawData)
```

## データの保存

これで，４名分の生データを読み込んだので，今度は，これをcsvファイルとして保存します。csvファイルは，write.csv()を使って，保存できます。

```
write.csv(rawData, "rawData.csv", quote=FALSE, row.names=FALSE)
```

## IDの対応表

上記の作業では，for文でのiをIDとしているが，それが実際のどのファイルに対応するのか対応づけできてない。そこで，以下では，上記と同じようなfor文を使って，iとフォルダのファイル名との対応づけをした対応表(id)を作成する。

```{r}
id <- NULL
for(i in 1:numberSubject){
  id$csvName[i] <- fileNames[i]
  id$dataId[i] <- i
}
id <- as.data.frame(id)
print(id)
```

# もう少し処理をしたデータの読み込みと保存
## データの読み込み

上記では，フォルダ内のすべてのcsvファイルを読み込んで，その生データを統合して，csvファイルとして保存しました。私個人としては，このように各試行ごとのデータを使って解析した方が良いと考えますが，目的によっては，各試行ごとのデータではなく，全試行における正答率などを参加者ごとに計算した場合もあるかと思います。今回は，各参加者のデータを読み込んで，key_pressで紫を選んだ比率（1が紫，緑は0）と正答率(correctでは1が正答，0が誤答)を各参加者ごとに保存する（rateDataに保存する）。

```{r}
# 保存場所の準備
rateData <- NULL
for(i in 1:numberSubject){
  # フォルダ内の読み込んだcsvファイルのデータをtempDataに保存（tempは一時的を意味するtemporaryの省略です）。
  tempData <- read.csv(paste(workDir, "Data",fileNames[i], sep = "/"))
  # 以下は１つまでの処理を変数名をtempDataに変えただけで，そのまま実行
  # trial_typeがcategorizeのデータに絞る
  tempData <- subset(tempData,trial_type=="categorize")
  # correctはtrue,falseなので，trueは1,falseは0にする
  tempData$correct <- as.numeric(as.logical(tempData$correct))
  # key_pressは，90だと紫，77だと緑なので，90は1，77は0にする。
  tempData$key_press[tempData$key_press==90] <- 1
  tempData$key_press[tempData$key_press==77] <- 0
  #ここまでは，これまでと同じ
  
  #　以下で紫の選択率と正答率などの計算
  rateData$id[i] <- i
  # 紫の選択率
  rateData$purpleRate[i] <- sum(tempData$correct)/length(tempData$correct)
  # 正答率
  rateData$correctRate[i] <- sum(tempData$key_press)/length(tempData$key_press)
}
#データフレーム化と結果の表示
rateData <- as.data.frame(rateData)
head(rateData)
```

## データの保存

rateDataをcsv形式で保存する。

```
write.csv(rateData, "rateData.csv", quote=FALSE, row.names=FALSE)
```

# おわりに

これで，解析用のデータセットを作ることができました。あとは，Rで解析してもよし，SPSSやHADで解析しても良いです（個人的にはRを薦めますが・・・）。統計解析する前に，必ずデータの可視化（プロット）をしましょう！
